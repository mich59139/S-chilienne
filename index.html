<!doctype html>
<html lang="fr">
<head>
  <meta charset="utf-8"/>
  <meta name="viewport" content="width=device-width, initial-scale=1"/>
  <title>S√©chilienne ‚Äî Histoire (hi√©rarchie + sous-pages)</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"/>
  <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
  <script src="https://unpkg.com/marked@12.0.2/marked.min.js"></script>
  <style>
    .no-scrollbar::-webkit-scrollbar{ display:none; }
    .no-scrollbar{ -ms-overflow-style:none; scrollbar-width:none; }
    #map { height: 26rem; }
    @media (min-width: 768px){ #map { height: 32rem; } }
    .leaflet-control-layers-expanded { max-height: 220px; overflow:auto; }
    .prose p{ margin: .5rem 0; }
  </style>
</head>
<body class="min-h-screen bg-[radial-gradient(ellipse_at_top,_#f6f2ea,_#ece7df)] text-neutral-900">
  <div id="root"></div>

  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone@7/babel.min.js"></script>

  <script type="text/babel">
    /*************** Chargement des donn√©es ***************/
    const DEFAULT_DATA = {
      eras: [
        { id: "all", label: "Tout" },
        { id: "antiquite", label: "Antiquit√©" },
        { id: "moyenage", label: "Moyen √Çge" },
        { id: "modernes", label: "Temps modernes" },
        { id: "revolution", label: "R√©volution & Empire" },
      ],
      events: [
        {
          id:"ant-1", slug:"voie-romaine", year:"Ier‚ÄìIVe s.", era:"antiquite",
          title:"Voie romaine de la Romanche",
          summary:"Itin√©raire antique reliant la cuvette grenobloise au haut Oisans.",
          tags:["patrimoine","arch√©o","voie"],
          group:"Antiquit√© ‚Äî itin√©raires",
          order: 10, importance: 3,
          body:"# Voie romaine\n\nTron√ßons encore visibles en vall√©e (photos, sources √† ajouter)."
        },
        {
          id:"ma-1", slug:"guigues-alleman", year:"v. 1195‚Äì1248", era:"moyenage",
          title:"Guigues I·µâ ≥ Alleman",
          summary:"Premier seigneur de S√©chilienne attest√©.",
          tags:["seigneurs","Alleman"],
          group:"Moyen √Çge ‚Äî seigneuries",
          order: 20, importance: 3,
          body:"# Guigues I·µâ ≥ Alleman\n\nPoint de d√©part de la chronologie seigneuriale locale."
        },
        {
          id:"ma-3", slug:"transport-dauphine-1349", year:"1349", era:"moyenage",
          title:"Transport du Dauphin√© √† la France",
          summary:"Changement de tutelle : effets sur justice et fiscalit√©.",
          tags:["contexte","Dauphin√©"],
          group:"Moyen √Çge ‚Äî contexte delphinal",
          order: 30, importance: 2,
          body:"# 1349 : Transport du Dauphin√©\n\nContexte et impacts √† pr√©ciser pour S√©chilienne."
        },
        {
          id:"tm-2", slug:"maison-du-mottet", year:"XVIIe s.", era:"modernes",
          title:"Maison du Mottet",
          summary:"Mont√©e en puissance locale ; toponymie (Croix du Mottet).",
          tags:["du Mottet","toponymie"],
          group:"Temps modernes ‚Äî maisons",
          order: 50, importance: 2,
          body:"# Maison du Mottet\n\nR√¥le et toponymie ; sources √† int√©grer."
        },
        {
          id:"re-4", slug:"route-napoleon-1815", year:"7 mars 1815", era:"revolution",
          title:"Route Napol√©on (Laffrey, proximit√©)",
          summary:"√âpisode des Cent-Jours √† proximit√© de S√©chilienne.",
          tags:["Napol√©on","Cent-Jours"],
          group:"R√©volution & Empire",
          order: 90, importance: 1,
          body:"# 7 mars 1815\n\nRencontre √† Laffrey ; encadrer pour l‚Äôhistoire locale."
        }
      ],
      pois: [
        { id:"voie", slug:"poi-voie-romaine", name:"Voie romaine (tron√ßon)", lat:45.055, lng:5.820, kind:"patrimoine", note:"Segment √† photographier / sourcer", order: 10, body:"Tron√ßon probable. √Ä sourcer." },
        { id:"eglise", slug:"poi-eglise", name:"√âglise / noyau paroissial", lat:45.048, lng:5.839, kind:"patrimoine", note:"Ancrage m√©di√©val (√† pr√©ciser)", order: 20, body:"√âglise et cimeti√®re ancien." },
        { id:"chat", slug:"poi-chateau", name:"Ch√¢teau de S√©chilienne", lat:45.053, lng:5.840, kind:"patrimoine", note:"Existence ant√©rieure (incendie 1944 hors p√©riode)", order: 30, body:"Site castral ; iconographie √† r√©unir." },
      ],
      families: [
        { name:"Alleman",  slug:"fam-alleman",  period:"XIIIe‚ÄìXIVe",  note:"Lign√©e initiale.", order: 10, body:"D√©tails, actes et hommages." },
        { name:"Simiane",  slug:"fam-simiane",  period:"XVIe",        note:"Transmission/alliances.", order: 20, body:"Filiations √† pr√©ciser." },
        { name:"du Mottet",slug:"fam-du-mottet",period:"XVIIe‚ÄìXVIIIe",note:"Toponymie et r√¥le local.", order: 30, body:"Rep√®res et sources." }
      ]
    };

    async function loadData() {
      try {
        const res = await fetch('data.json', { cache: 'no-store' });
        if (!res.ok) throw new Error('no data.json');
        return await res.json();
      } catch {
        return DEFAULT_DATA;
      }
    }

    /*************** Utilitaires ***************/
    function byOrder(a,b){ return (a.order ?? 999) - (b.order ?? 999); }
    function groupBy(arr, key, fallback="Autres"){
      return arr.reduce((acc, it) => {
        const k = (it[key] || fallback);
        (acc[k] ||= []).push(it);
        return acc;
      }, {});
    }
    function goTo(hash){ location.hash = hash; }
    function parseRoute(){
      const h = location.hash.slice(1);
      const parts = h.split('/').filter(Boolean);
      if(parts[0]==='fiche' && parts.length>=3){
        return { name:'fiche', type:parts[1], slug:parts.slice(2).join('/') };
      }
      return { name:'home' };
    }

    /*************** Petits composants UI ***************/
    const Pill = ({ active, children, onClick }) => (
      <button onClick={onClick} className={`px-3 py-1 rounded-full text-sm transition-all border ${active ? 'bg-black/90 text-white border-black shadow' : 'bg-white/70 backdrop-blur border-black/10 hover:bg-white'}`}>{children}</button>
    );
    const Card = ({ children, className='' }) => (
      <div className={`rounded-2xl border border-black/10 bg-white/80 backdrop-blur shadow-sm ${className}`}>{children}</div>
    );
    const SectionTitle = ({ icon, title, subtitle }) => (
      <div className="flex items-end justify-between gap-4">
        <div>
          <h2 className="text-2xl md:text-3xl font-semibold tracking-tight flex items-center gap-3">
            <span className="inline-flex h-9 w-9 items-center justify-center rounded-xl border border-black/10 bg-white/70">{icon}</span>
            {title}
          </h2>
          {subtitle && <p className="text-sm text-black/60 mt-1">{subtitle}</p>}
        </div>
      </div>
    );

    /*************** Carte ***************/
    function CarteLeaflet({ pois }){
      const mapRef = React.useRef(null);
      React.useEffect(() => {
        const map = L.map(mapRef.current).setView([45.050, 5.840], 12);
        L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{y}/{x}.png'.replace('/{y}/{x}', '/{x}/{y}'), {
          maxZoom: 19,
          attribution: '&copy; OpenStreetMap contributors'
        }).addTo(map);

        const groups = {};
        const markers = [];
        [...pois].sort(byOrder).forEach(p => {
          const color = p.kind === 'patrimoine' ? '#1f2937' : p.kind === 'm√©moire' ? '#7c2d12' : '#0f172a';
          const icon = L.divIcon({
            className: 'custom-pin',
            html: `<span style="display:inline-block;width:12px;height:12px;border-radius:9999px;background:${color};border:2px solid #fff;box-shadow:0 0 0 2px rgba(0,0,0,.15)"></span>`,
            iconSize: [14,14], iconAnchor: [7,7]
          });
          const m = L.marker([p.lat, p.lng], { icon })
            .bindPopup(`<strong>${p.name}</strong><br/><small>${p.kind}</small><br/>${p.note} <br/><a href="#/fiche/poi/${p.slug}">Fiche ‚Üí</a>`);
          (groups[p.kind] ||= L.layerGroup()).addLayer(m);
          markers.push(m);
        });
        Object.entries(groups).forEach(([k,g]) => g.addTo(map));
        L.control.layers({}, groups, { collapsed:false }).addTo(map);
        if(markers.length){ map.fitBounds(L.featureGroup(markers).getBounds().pad(0.2)); }
        return () => map.remove();
      }, [pois]);

      return (
        <Card className="p-4 md:p-6">
          <SectionTitle icon={<span>üó∫Ô∏è</span>} title="Carte (rep√®res historiques)" subtitle="Cliquez un marqueur puis ¬´ Fiche ‚Üí ¬ª pour la sous-page."/>
          <div id="map" ref={mapRef} className="rounded-2xl border border-black/10 overflow-hidden"></div>
        </Card>
      );
    }

    /*************** Frise (group√©e + tri√©e) ***************/
    function Frise({ events, eraFilter }){
      const filtered = React.useMemo(
        () => events.filter(e => eraFilter === 'all' || e.era === eraFilter).sort(byOrder),
        [events, eraFilter]
      );
      const groups = React.useMemo(() => groupBy(filtered, 'group'), [filtered]);

      return (
        <Card className="p-4 md:p-6">
          <SectionTitle icon={<span>üï∞Ô∏è</span>} title="Frise (fondations ‚Üí 1815)" subtitle="Regroup√©e par th√®mes, tri√©e par ordre"/>
          <div className="mt-4 space-y-6">
            {Object.entries(groups).map(([group, items]) => (
              <div key={group}>
                <div className="mb-2 text-xs uppercase tracking-wide text-black/60">{group}</div>
                <div className="overflow-x-auto no-scrollbar">
                  <div className="flex gap-4 min-w-max pr-4">
                    {items.map(e => (
                      <button
                        key={e.id}
                        onClick={()=>goTo(`#/fiche/event/${e.slug}`)}
                        className={`w-80 shrink-0 transition-transform text-left ${e.importance===3 ? "scale-[1.05]" : e.importance===2 ? "scale-[1.025]" : ""}`}
                        title="Ouvrir la fiche"
                      >
                        <div className="h-full rounded-2xl border border-black/10 bg-gradient-to-b from-white to-white/60 p-4 hover:shadow-md">
                          <div className="text-xs tracking-wide uppercase text-black/60">{e.year}</div>
                          <div className="mt-1 text-lg font-semibold">{e.title}</div>
                          <p className="mt-2 text-sm text-black/70 leading-relaxed">{e.summary}</p>
                          <div className="mt-3 flex flex-wrap gap-2">
                            {(e.tags||[]).map(t => (
                              <span key={t} className="px-2 py-0.5 text-xs rounded-full border border-black/10 bg-white/70">{t}</span>
                            ))}
                          </div>
                        </div>
                      </button>
                    ))}
                  </div>
                </div>
              </div>
            ))}
          </div>
        </Card>
      );
    }

    /*************** G√©n√©alogies ***************/
    function Genealogies({ families }){
      const items = React.useMemo(()=>[...families].sort(byOrder), [families]);
      return (
        <Card className="p-4 md:p-6">
          <SectionTitle icon={<span>üå≥</span>} title="Maisons seigneuriales" subtitle="Alleman ‚Üí Simiane ‚Üí du Mottet (sch√©ma simplifi√©)."/>
          <div className="mt-6 grid grid-cols-1 md:grid-cols-3 gap-4 items-start">
            {items.map((f, idx) => (
              <div key={f.slug} className="relative">
                {idx < items.length - 1 && <div className="hidden md:block absolute top-10 left-full w-8 h-0.5 bg-black/10"/>}
                <button onClick={()=>goTo(`#/fiche/family/${f.slug}`)} className="w-full text-left p-4 rounded-2xl border border-black/10 bg-white/70 hover:shadow">
                  <div className="text-lg font-semibold">{f.name}</div>
                  <div className="text-xs text-black/60 uppercase tracking-wide">{f.period}</div>
                  <p className="text-sm text-black/70 mt-2">{f.note}</p>
                </button>
              </div>
            ))}
          </div>
          <p className="mt-4 text-xs text-black/60">Cliquez une maison pour ouvrir sa fiche d√©taill√©e.</p>
        </Card>
      );
    }

    /*************** Vue Fiche (sous-page) ***************/
    function Fiche({ type, slug, data }){
      let item, title, subtitle;
      if(type==='event'){ item = data.events.find(e=>e.slug===slug); title = item?.title; subtitle = item?.year; }
      if(type==='poi'){ item = data.pois.find(e=>e.slug===slug); title = item?.name; subtitle = item?.kind; }
      if(type==='family'){ item = data.families.find(e=>e.slug===slug); title = item?.name; subtitle = item?.period; }
      if(!item){
        return (
          <Card className="p-4 md:p-6">
            <div className="flex items-center justify-between"><h2 className="text-xl font-semibold">Fiche introuvable</h2><button className="px-3 py-2 rounded-lg border" onClick={()=>goTo('#')}>Retour</button></div>
            <p className="text-sm text-black/60 mt-2">V√©rifiez le slug dans vos donn√©es.</p>
          </Card>
        );
      }
      const html = item.body ? marked.parse(item.body) : "<p class='text-black/60'>Aucun contenu d√©taill√© pour l‚Äôinstant.</p>";
      return (
        <div className="space-y-4">
          <Card className="p-4 md:p-6">
            <div className="flex items-center justify-between">
              <div>
                <div className="text-xs tracking-wide uppercase text-black/60">{subtitle||""}</div>
                <h1 className="text-2xl md:text-3xl font-semibold">{title}</h1>
              </div>
              <button className="px-3 py-2 rounded-lg border" onClick={()=>history.back()}>‚Üê Retour</button>
            </div>
            <div className="prose mt-4" dangerouslySetInnerHTML={{__html: html}}></div>
          </Card>
          {(type!=='poi') && (
            <Card className="p-4 md:p-6">
              <div className="text-sm text-black/60">Astuce : ajoutez **images, sources et cartes** dans le champ *body* en Markdown.</div>
            </Card>
          )}
        </div>
      );
    }

    /*************** Admin (√©dition minimale) ***************/
    function Field({ label, children }){ return <label className="block text-sm mb-2">{label}<div className="mt-1">{children}</div></label>; }
    function Input(props){ return <input {...props} className={"w-full rounded-lg border border-black/15 px-3 py-2 text-sm bg-white/90 "+(props.className||"")} /> }
    function Textarea(props){ return <textarea {...props} className={"w-full rounded-lg border border-black/15 px-3 py-2 text-sm bg-white/90 "+(props.className||"")} /> }

    function AdminPanel({data, setData}){
      const [tab, setTab] = React.useState('events');
      const [selected, setSelected] = React.useState(null);

      function update(collection, index, patch){
        const clone = structuredClone(data);
        Object.assign(clone[collection][index], patch);
        setData(clone);
      }
      function add(collection, obj){
        const clone = structuredClone(data);
        clone[collection].push(obj);
        setData(clone);
        setSelected(clone[collection].length-1);
      }
      function remove(collection, index){
        const clone = structuredClone(data);
        clone[collection].splice(index,1);
        setData(clone);
        setSelected(null);
      }
      function exportJSON(){
        const blob = new Blob([JSON.stringify(data, null, 2)], {type:"application/json"});
        const a = document.createElement('a');
        a.href = URL.createObjectURL(blob);
        a.download = "data.json";
        a.click();
      }

      const list = data[tab];
      const cur = selected!=null ? list[selected] : null;

      return (
        <div className="fixed inset-0 z-50 bg-black/30 backdrop-blur-sm flex">
          <div className="w-80 bg-white h-full border-r border-black/10 p-3 overflow-y-auto">
            <div className="flex gap-1 mb-2">
              {["events","pois","families"].map(t=>(
                <button key={t} onClick={()=>{setTab(t);setSelected(null);}} className={"px-3 py-2 rounded-lg border "+(tab===t?"bg-black text-white border-black":"bg-white border-black/10")}>
                  {t==="events"?"Frise":t==="pois"?"Carte":"Maisons"}
                </button>
              ))}
            </div>
            <div className="text-xs text-black/60 mb-2">S√©lectionnez un √©l√©ment pour l‚Äô√©diter.</div>
            <div className="space-y-1">
              {list.map((it, i)=>(
                <button key={i} onClick={()=>setSelected(i)} className={"w-full text-left px-3 py-2 rounded-lg border "+(selected===i?"bg-black text-white border-black":"bg-white border-black/10 hover:bg-black/5")}>
                  <div className="text-sm font-medium truncate">{it.title||it.name}</div>
                  <div className="text-xs opacity-70 truncate">{it.year||it.kind||it.period}</div>
                </button>
              ))}
            </div>
            <div className="mt-3 grid grid-cols-2 gap-2">
              {tab==="events" && <button className="px-3 py-2 rounded-lg border" onClick={()=>add("events",{id:"new-"+Date.now(),slug:"",year:"",era:"moyenage",title:"",summary:"",tags:[],group:"",order:999,importance:1,body:""})}>+ √âv√©nement</button>}
              {tab==="pois" && <button className="px-3 py-2 rounded-lg border" onClick={()=>add("pois",{id:"p-"+Date.now(),slug:"",name:"",lat:45,lng:5.8,kind:"patrimoine",note:"",order:999,body:""})}>+ Lieu</button>}
              {tab==="families" && <button className="px-3 py-2 rounded-lg border" onClick={()=>add("families",{name:"",slug:"",period:"",note:"",order:999,body:""})}>+ Maison</button>}
              {selected!=null && <button className="px-3 py-2 rounded-lg border" onClick={()=>remove(tab,selected)}>üóë Supprimer</button>}
            </div>
            <div className="mt-4">
              <button className="px-3 py-2 rounded-lg border w-full" onClick={exportJSON}>‚¨áÔ∏è Exporter data.json</button>
            </div>
            <div className="mt-3 text-[11px] text-black/60">Publiez <code>data.json</code> √† la racine du d√©p√¥t pour alimenter le site.</div>
            <div className="mt-6 text-[11px] text-black/50">Champs cl√©s : <code>group</code>, <code>order</code>, <code>importance</code>, <code>slug</code>, <code>body</code>.</div>
          </div>
          <div className="flex-1 bg-white h-full p-4 overflow-y-auto">
            <div className="flex justify-between items-center">
              <div className="font-semibold">√âdition {tab==='events'?'‚Äî Frise':tab==='pois'?'‚Äî Carte':'‚Äî Maisons'}</div>
              <button className="px-3 py-2 rounded-lg border" onClick={()=>document.dispatchEvent(new CustomEvent('close-admin'))}>Fermer</button>
            </div>
            {!cur && <div className="text-sm text-black/60 mt-4">S√©lectionnez un √©l√©ment √† gauche.</div>}
            {cur && tab==="events" && (
              <div className="mt-4 grid md:grid-cols-2 gap-4">
                <Field label="ID"><Input value={cur.id} onChange={e=>update('events',selected,{id:e.target.value})}/></Field>
                <Field label="Slug (url-friendly)"><Input value={cur.slug||""} onChange={e=>update('events',selected,{slug:e.target.value})}/></Field>
                <Field label="Ann√©e / p√©riode"><Input value={cur.year||""} onChange={e=>update('events',selected,{year:e.target.value})}/></Field>
                <Field label="√âpoque (antiquite, moyenage, modernes, revolution)"><Input value={cur.era||""} onChange={e=>update('events',selected,{era:e.target.value})}/></Field>
                <Field label="Titre"><Input value={cur.title||""} onChange={e=>update('events',selected,{title:e.target.value})}/></Field>
                <Field label="R√©sum√©"><Textarea rows="4" value={cur.summary||""} onChange={e=>update('events',selected,{summary:e.target.value})}/></Field>
                <Field label="Tags (s√©par√©s par des virgules)"><Input value={(cur.tags||[]).join(', ')} onChange={e=>update('events',selected,{tags:e.target.value.split(',').map(s=>s.trim()).filter(Boolean)})}/></Field>
                <Field label="Groupe"><Input value={cur.group||""} onChange={e=>update('events',selected,{group:e.target.value})}/></Field>
                <Field label="Ordre (nombre)"><Input type="number" value={cur.order??999} onChange={e=>update('events',selected,{order:parseInt(e.target.value,10)})}/></Field>
                <Field label="Importance (1-3)"><Input type="number" min="1" max="3" value={cur.importance??1} onChange={e=>update('events',selected,{importance:parseInt(e.target.value,10)})}/></Field>
                <div className="md:col-span-2">
                  <Field label="Contenu (Markdown)"><Textarea rows="8" value={cur.body||""} onChange={e=>update('events',selected,{body:e.target.value})}/></Field>
                </div>
              </div>
            )}
            {cur && tab==="pois" && (
              <div className="mt-4 grid md:grid-cols-2 gap-4">
                <Field label="ID"><Input value={cur.id} onChange={e=>update('pois',selected,{id:e.target.value})}/></Field>
                <Field label="Slug"><Input value={cur.slug||""} onChange={e=>update('pois',selected,{slug:e.target.value})}/></Field>
                <Field label="Nom"><Input value={cur.name||""} onChange={e=>update('pois',selected,{name:e.target.value})}/></Field>
                <Field label="Latitude"><Input type="number" step="0.000001" value={cur.lat} onChange={e=>update('pois',selected,{lat:parseFloat(e.target.value)})}/></Field>
                <Field label="Longitude"><Input type="number" step="0.000001" value={cur.lng} onChange={e=>update('pois',selected,{lng:parseFloat(e.target.value)})}/></Field>
                <Field label="Cat√©gorie"><Input value={cur.kind||""} onChange={e=>update('pois',selected,{kind:e.target.value})}/></Field>
                <Field label="Ordre"><Input type="number" value={cur.order??999} onChange={e=>update('pois',selected,{order:parseInt(e.target.value,10)})}/></Field>
                <div className="md:col-span-2">
                  <Field label="Note"><Textarea rows="3" value={cur.note||""} onChange={e=>update('pois',selected,{note:e.target.value})}/></Field>
                  <Field label="Contenu (Markdown)"><Textarea rows="6" value={cur.body||""} onChange={e=>update('pois',selected,{body:e.target.value})}/></Field>
                </div>
              </div>
            )}
            {cur && tab==="families" && (
              <div className="mt-4 grid md:grid-cols-2 gap-4">
                <Field label="Nom"><Input value={cur.name||""} onChange={e=>update('families',selected,{name:e.target.value})}/></Field>
                <Field label="Slug"><Input value={cur.slug||""} onChange={e=>update('families',selected,{slug:e.target.value})}/></Field>
                <Field label="P√©riode"><Input value={cur.period||""} onChange={e=>update('families',selected,{period:e.target.value})}/></Field>
                <Field label="Ordre"><Input type="number" value={cur.order??999} onChange={e=>update('families',selected,{order:parseInt(e.target.value,10)})}/></Field>
                <div className="md:col-span-2">
                  <Field label="Note"><Textarea rows="3" value={cur.note||""} onChange={e=>update('families',selected,{note:e.target.value})}/></Field>
                  <Field label="Contenu (Markdown)"><Textarea rows="6" value={cur.body||""} onChange={e=>update('families',selected,{body:e.target.value})}/></Field>
                </div>
              </div>
            )}
          </div>
        </div>
      );
    }

    /*************** App + Router ***************/
    function App(){
      const [data, setData] = React.useState(DEFAULT_DATA);
      const [tab, setTab] = React.useState('carte');
      const [era, setEra] = React.useState('all');
      const [route, setRoute] = React.useState(parseRoute());
      const [adminOpen, setAdminOpen] = React.useState(false);
      const isAdmin = new URLSearchParams(location.search).get('admin') === '1';

      React.useEffect(()=>{ loadData().then(setData); }, []);
      React.useEffect(()=>{
        const onHash = ()=> setRoute(parseRoute());
        window.addEventListener('hashchange', onHash);
        return ()=>window.removeEventListener('hashchange', onHash);
      }, []);
      React.useEffect(()=>{
        const close = ()=>setAdminOpen(false);
        document.addEventListener('close-admin', close);
        return ()=>document.removeEventListener('close-admin', close);
      },[]);

      return (
        <div>
          <header className="sticky top-0 z-30 backdrop-blur bg-[rgba(255,255,255,0.65)] border-b border-black/10">
            <div className="mx-auto max-w-6xl px-4 py-3 flex items-center justify-between gap-4">
              <div>
                <h1 className="text-xl md:text-2xl font-bold tracking-tight">S√©chilienne ‚Äî Histoire vivante</h1>
                <p className="text-xs md:text-sm text-black/60">Carte ‚Ä¢ Frise ‚Ä¢ Maisons ‚Ä¢ Fiches</p>
              </div>
              <nav className="flex items-center gap-1">
                {route.name==='home' && ([
                  { id:'carte', label:'Carte' },
                  { id:'frise', label:'Frise' },
                  { id:'genea', label:'Maisons' },
                ]).map(t => (
                  <button key={t.id} className={`px-3 py-2 rounded-xl text-sm border transition ${tab===t.id ? 'bg-black text-white border-black shadow' : 'bg-white/70 border-black/10 hover:bg-white'}`} onClick={() => setTab(t.id)}>{t.label}</button>
                ))}
                {isAdmin && <button className="px-3 py-2 rounded-xl text-sm border" onClick={()=>setAdminOpen(true)}>‚úèÔ∏è Modifier</button>}
              </nav>
            </div>
          </header>

          <main className="mx-auto max-w-6xl px-4 py-6 space-y-6">
            {route.name==='home' ? (
              <>
                <Card className="p-3">
                  <div className="flex flex-wrap items-center gap-2">
                    <span className="text-sm text-black/60 mr-1">Filtrer la p√©riode :</span>
                    {data.eras.map(e => <Pill key={e.id} active={era===e.id} onClick={() => setEra(e.id)}>{e.label}</Pill>)}
                  </div>
                </Card>

                {tab==='carte' && <CarteLeaflet pois={data.pois}/>}
                {tab==='frise' && <Frise events={data.events} eraFilter={era}/>}
                {tab==='genea' && <Genealogies families={data.families}/>}
              </>
            ) : (
              <Fiche type={route.type} slug={route.slug} data={data}/>
            )}

            <Card className="p-4 md:p-6">
              <SectionTitle icon={<span>üß≠</span>} title="M√©thodologie & sources (√† int√©grer)" subtitle="Compl√©ter avant publication d√©finitive"/>
              <ul className="mt-4 grid md:grid-cols-3 gap-3 text-sm text-black/80 list-disc list-inside">
                <li>Inventaire des tron√ßons de <strong>voie romaine</strong> (photos, coords, bibliographie).</li>
                <li><strong>Chartes et hommages</strong> pour Alleman ‚Üí Simiane ‚Üí du Mottet.</li>
                <li>Contexte du <strong>Transport du Dauphin√© (1349)</strong> avec impacts locaux.</li>
                <li>Dossiers <strong>Lesdigui√®res</strong> (Vizille) et interactions avec S√©chilienne.</li>
                <li>Archives communales : 1789‚Äì1793 (<strong>biens nationaux</strong>, d√©lib√©rations).</li>
                <li>Encadr√© <strong>7 mars 1815</strong> : Route Napol√©on (Laffrey) et perception locale.</li>
              </ul>
              <div className="mt-4 text-xs text-black/60">Les champs <code>slug</code>, <code>group</code>, <code>order</code>, <code>importance</code> et <code>body</code> pilotent hi√©rarchie et sous-pages.</div>
            </Card>
          </main>

          <footer className="mx-auto max-w-6xl px-4 pb-10 text-xs text-black/50">Gabarit ¬© 2025 ‚Äî Commune de S√©chilienne / AHPV ‚Äî Donn√©es via data.json ‚Äî React UMD + Leaflet + Tailwind ‚Äî Sous-pages par hash.</footer>

          {adminOpen && <AdminPanel data={data} setData={setData} />}
        </div>
      );
    }

    /*************** Bootstrap ***************/
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App/>);
  </script>
</body>
</html>
